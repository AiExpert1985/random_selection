const MAX = 8000;
const INTERVAL = 25;
const COLORS = ["red", "black", "blue", "yellow", "green", "Indigo", "orange"];
const SELECT = "أختيار رقم عشوائي";
const RESTART = "محاولة جديدة";
var selectedList = [];

document.addEventListener('DOMContentLoaded', function(){
	var button = document.querySelector("#random-button");
	button.innerHTML = SELECT;
	var numberChanging = setInterval(display_random_numbers, INTERVAL);
 	button.onclick = function() {
		if(button.innerHTML == SELECT){
			clearInterval(numberChanging);
			button.innerHTML = RESTART;
			numberElement = document.querySelector("#number");
			numberElement.style.color = "black";
			numberElement.innerHTML = unrepeated_random_number();
		}
		else{
			numberChanging = setInterval(display_random_numbers, INTERVAL);
			button.innerHTML = SELECT;
		}
	};
	resuls = document.querySelector("#resuls");
	resuls.onclick = create_excel;
});

function unrepeated_random_number(){
	if(selectedList.length == MAX){
		return "تم اختيار جميع الارقام"; // all numbers were selected
	}
	var newNumber = Math.floor((Math.random() * MAX) + 1);
	if(!selectedList.includes(newNumber)){
		selectedList.push(newNumber);
		return newNumber;
	}
	return unrepeated_random_number();
}

function display_random_numbers(){
	number = Math.floor((Math.random() * MAX) + 1);
	numberElement = document.querySelector("#number");
	numberElement.innerHTML = number;
	numberElement.style.color = COLORS[ Math.floor(Math.random() * COLORS.length)];
}

function create_excel(){
    var wb = XLSX.utils.book_new();
    wb.SheetNames.push("النتائج");
    var ws_data = [["التسلسل","رقم الوصل"]];
	for(var i = 0; i < selectedList.length; i++){
		var sequence = i+1;
		var number = selectedList[i];
		ws_data.push([sequence, number]);
	}
    var ws = XLSX.utils.aoa_to_sheet(ws_data);
    wb.Sheets["النتائج"] = ws;
    var wbout = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});
    saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), 'نتائج القرعة الاكترونية.xlsx');
}

function s2ab(s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
}
